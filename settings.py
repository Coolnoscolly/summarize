import os
from dotenv import load_dotenv

load_dotenv()  # Загружаем .env, если существует, но все настройки имеют defaults здесь


class Settings:
    # MinIO/S3 settings
    MINIO_ENDPOINT = os.getenv("MINIO_ENDPOINT", "")
    MINIO_ACCESS_KEY = os.getenv("MINIO_ACCESS_KEY", "")
    MINIO_SECRET_KEY = os.getenv(
        "MINIO_SECRET_KEY", ""
    )
    MINIO_BUCKET_NAME = os.getenv("MINIO_BUCKET_NAME", "")
    MINIO_SECURE = os.getenv("MINIO_SECURE", "false").lower() == "true"
    MINIO_REGION = os.getenv("MINIO_REGION", "")
    MINIO_VERIFY_SSL = os.getenv("MINIO_VERIFY_SSL", "true")
    MINIO_SAMPLE_FRACTION = float(os.getenv("MINIO_SAMPLE_FRACTION", "0.25"))
    MINIO_SAMPLE_RANDOM = os.getenv("MINIO_SAMPLE_RANDOM", "true").lower() == "true"
    MINIO_SAMPLE_SEED = (
        int(os.getenv("MINIO_SAMPLE_SEED", "42"))
        if os.getenv("MINIO_SAMPLE_SEED")
        else None
    )
    MINIO_FOLDER_PREFIX = os.getenv("MINIO_FOLDER_PREFIX", None)

    # Ollama settings
    OLLAMA_HOST = os.getenv("OLLAMA_HOST", "")
    OLLAMA_MODEL = os.getenv("OLLAMA_MODEL", "qwen2.5:32b")
    OLLAMA_TEMPERATURE = float(os.getenv("OLLAMA_TEMPERATURE", "0.2"))
    OLLAMA_TOP_P = float(os.getenv("OLLAMA_TOP_P", "0.9"))
    OLLAMA_NUM_PREDICT_PAIR = int(os.getenv("OLLAMA_NUM_PREDICT_PAIR", "5096"))
    OLLAMA_NUM_PREDICT_FINAL = int(os.getenv("OLLAMA_NUM_PREDICT_FINAL", "34048"))

    # Document processing
    OUTPUT_FILE = os.getenv("OUTPUT_FILE", "./summary.txt")
    ALLOWED_EXTENSIONS = os.getenv("ALLOWED_EXTENSIONS", ".txt,.md").split(",")
    MAX_CHUNK_SIZE = int(os.getenv("MAX_CHUNK_SIZE", "5000"))
    CHUNK_OVERLAP = int(os.getenv("CHUNK_OVERLAP", "200"))
    MAX_WORKERS = int(os.getenv("MAX_WORKERS", "4"))
    SHUFFLE_CHUNKS = os.getenv("SHUFFLE_CHUNKS", "false").lower() == "true"

    # Summary settings
    FINAL_STYLE = os.getenv("FINAL_STYLE", "narrative")
    TARGET_BULLETS_PAIR = int(os.getenv("TARGET_BULLETS_PAIR", "40"))
    TARGET_BULLETS_FINAL = int(os.getenv("TARGET_BULLETS_FINAL", "120"))
    MIN_FINAL_SENTENCES = int(os.getenv("MIN_FINAL_SENTENCES", "15"))

    # Prompt settings
    SYSTEM_PROMPT = os.getenv(
        "SYSTEM_PROMPT",
        """Ты — профессиональный аналитик данных и экспертный ассистент по обработке информации. Твоя задача — анализировать предоставленные тексты, извлекать конкретные факты и структурировать их в четком формате. Ты должен быть точен и избегать додумывания. Убедитесь, что вы следуете правилу 80/20: 80% основной ценности, используя 20% или меньше объема текста.

**ОБЩИЕ ИНСТРУКЦИИ ДЛЯ ВСЕХ ЗАДАЧ:**
1.  **Язык:** Всегда отвечай строго на русском языке.
2.  **Точность:** Извлекай и перефразируй информацию только из предоставленного текста. Если чего-то нет — не придумывай. Для отсутствующей информации используй пометку «Не обнаружено».
3.  **Фокус на данные:** В приоритете — извлечение конкретных данных: имен, дат, сумм, контактов, технических деталей.
4.  **Структура:** Поддерживай четкую структуру ответа, используй маркированные списки для перечислений.
5.  **Контекст:** Учитывай общий контекст документа (например, «договор», «отчет», «письмо»), даже если анализируешь его часть.""",
    )

    MERGE_PROMPT = os.getenv(
        "MERGE_PROMPT",
        """[ЗАДАЧА]: Объедини два представленных ниже фрагмента в один структурированный суммаризированный документ. Ты не должен ничего додумывать. Твоя цель — сохранить ВСЮ критически важную фактологическую информацию из обоих фрагментов, убрав воду и повторения. Убедитесь, что вы следуете правилу 80/20: 80% основной ценности, используя 20% или меньше объема текста.

**ИНСТРУКЦИЯ ПО СЛИЯНИЮ:**
1.  **Синтез, а не перечисление:** Не пересказывай фрагменты по отдельности («В первом тексте... во втором...»). Объедини информацию в единое связное резюме.
2.  **Приоритет фактов:** В первую очередь сохрани:
    *   **Конкретные данные:** Имена, фамилии, названия компаний, даты, сроки, суммы денег, номера (договоров, счетов, телефонов).
    *   **Контактную информацию:** email, адреса, телефоны.
    *   **Утверждения и выводы:** Ключевые тезисы, решения, проблемы, рекомендации.
3.  **Структура результата:** Твой ответ должен быть готов к следующему циклу объединения. Излагай информацию плотно и структурированно, используя краткие пункты и списки где это уместно.
4.  **Общий контекст:** Если оба фрагмента явно относятся к одному документу (например, это две части одного договора), отрази это в суммаризации (напр., «В договоре между X и Y...»).

В результате должен получиться сжатый, но насыщенный фактами текст на русском языке.""",
    )

    FINAL_PROMPT = os.getenv(
        "FINAL_PROMPT",
        """[ЗАДАЧА]: На основе предоставленных промежуточных суммаризаций создай итоговый, исчерпывающий отчет по всему документу (или набору документов). Это финальная версия, которая должна содержать всю самую ценную информацию для пользователя. Убедитесь, что вы следуете правилу 80/20: 80% основной ценности, используя 20% или меньше объема текста.

**ИНСТРУКЦИЯ ДЛЯ ФИНАЛЬНОГО ОТЧЕТА:**
1.  **Структура:** Представь информацию в четко структурированном виде. Используй следующие разделы:
    *   **Общая характеристика документа:** Тип, цель, основная тема.
    *   **Ключевые субъекты:** Основные лица, организации, их роли и взаимосвязи.
    *   **Извлеченные данные:** Списком все конкретные данные: контакты, даты, финансовые суммы, номера, прочая важная конкретика.
    *   **Содержательная summary:** Основные выводы, заключения, выявленные проблемы, возможности и рекомендации.
2.  **Полнота:** Это последний этап, поэтому убедись, что ни одна важная деталь из промежуточных шагов не утеряна.
3.  **Ясность:** Излагай информацию четко, кратко и максимально информативно. Избегай двусмысленностей.

Итогом должен быть профессиональный отчет, по которому пользователь сможет понять все ключевые аспекты исходного документа.""",
    )

    PASS_THROUGH_MERGE_PROMPT = os.getenv(
        "PASS_THROUGH_MERGE_PROMPT",
        """[ЗАДАЧА]: Объедини два представленных фрагмента в один документ без уменьшения или потери информации. Просто объедини их содержимое, сохраняя все детали, и структурируй в coherentный текст.

**ИНСТРУКЦИЯ:**
1. Не убирай никакую информацию.
2. Объедини в единый нарратив или список, сохраняя все факты.
3. Используй русский язык.""",
    )


settings = Settings()
